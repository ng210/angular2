<html>
    <head>
        <script src="/js/lib/base/base.js"></script>
        <script>

var _audioContext = null
var _audioWorklet = null;
var _timer = null;
var _smpRate = 48000;
var _pitch = 55;
var _pitchElement = null;
var _f2r = Math.pow(2, 4/12);
var _isRunning = false;

var _note = 36;
var _phase = 0;

async function init() {
    var bpm = document.getElementById('bpm');
    bpm.onchange = e => setBpm.call(bpm, e);
    setBpm.call(bpm);

    _audioContext = new AudioContext();
    _audioContext.suspend();
    await _audioContext.audioWorklet.addModule('synth.out.js');
    _audioWorklet = new AudioWorkletNode(_audioContext, 'audio-processor', { outputChannelCount: [2] });
    _audioWorklet.port.postMessage({code:'init'});
    _audioWorklet.connect(_audioContext.destination);

    _button = document.querySelector('#start');
}

function start() {
    if (_isRunning) {
        _isRunning = false;
        _audioContext.suspend();
        _button.innerHTML = 'Start';
    } else {
        _isRunning = true;
        _audioContext.resume();
        startPlay();
        _button.innerHTML = 'Stop';
    }
}

var sequence = 
[
    // F,F,F',F, F,C,F,F, D#,F,F,D, F,F,C,A#
    // 0,0,12,0  0,7,0,0, 10,0,0,9, 0,0,7,5

     0, 0.8,  0, 0.0,
     0, 0.6,  0, 0.0,
    12, 1.0, 12, 0.0,
     0, 0.8,  0, 0.0,

     0, 0.8,  0, 0.0,
     7, 0.8,  7, 0.0,
     0, 1.0,  0, 0.0,
     0, 0.8,  0, 0.0,

    10, 0.8, 10, 0.0,
     0, 0.8,  0, 0.0,
     0, 0.8,  0, 0.0,
     9, 0.8,  9, 0.0,

     0, 0.8,  0, 0.0,
     0, 0.8,  0, 0.0,
     7, 0.8,  7, 0.0,
     5, 0.8,  5, 0.0
];

var counter = 0;
var bpm = 50;
var frame = 0;
var msPerFrame = 0;
var restTime = 0;
var lastTime = 0;

function startPlay() {
    lastTime = new Date().getTime();
    playNote();
}

function playNote() {
    if (_isRunning) {
        var time = new Date().getTime();
        var dt = time - lastTime;
        if ((restTime -= dt) <= 0) {
            _audioWorklet.port.postMessage({code:'setNote', note: _note+sequence[counter], velocity: sequence[counter+1] });
            counter += 2;
            if (counter == sequence.length) counter = 0;
            restTime += msPerFrame;
            //console.log(restTime);
        }
        //_audioWorklet.port.postMessage({code:'setControl', id: 81, value: Math.random()/*0.1 - 0.1*Math.cos(frame*2*Math.PI/512)*/ });
        _audioWorklet.port.postMessage({code:'setControl', id: 81, value: 0.4 - 0.4*Math.cos(frame*2*Math.PI/256) });
        // duration = msPerFrame - duration;
        // if (duration < 0) duration += msPerFrame;
        requestAnimationFrame(playNote);
        lastTime = time;
        frame++;
    }
}

function setBpm() {
    msPerFrame = 7500/this.value;
    console.log('msPerFrame: ' + msPerFrame);
}

function onpageload() {}

        </script>
    </head>
    <body onload="init()">
        <button id="start" onclick="start();">Start</button>
        <input type="number" id="bpm" min="60" max="180" step="1" value="92" />
    </body>
</html>